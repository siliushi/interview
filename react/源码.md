# å£°æ˜å¼UIåº“

+ JSX
+ propsç»„ä»¶å¯¹å¤–æ¥å£ï¼Œstateç»„ä»¶å†…éƒ¨çŠ¶æ€
+ ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ


reactæºç    Reactæºç æ·±åº¦è§£æï¼šä»ç†å¿µåˆ°æ¶æ„ï¼Œä»æ¶æ„åˆ°å®ç°ï¼Œä»å®ç°åˆ°å…·ä½“ä»£ç ã€‚
https://react.iamkasong.com/
https://pomb.us/build-your-own-react/



setTimeout å»¶è¿ŸåŠ è½½ ï¼ˆä½¿ç”¨ä¸å½“å¯èƒ½é€‚å¾—å…¶åï¼‰
web worker å¤šçº¿ç¨‹ ï¼ˆä¸èƒ½æ“ä½œdomï¼Œä¸»è¦è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼‰
requestIdleCallback å¸§ç©ºé—²æ—¶è¿è¡Œ ï¼ˆreact18å¸¦ğŸ”¥çš„ï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼‰
requestAnimationFrame æ¯å¸§éƒ½ä¼šè¿è¡Œ ï¼ˆä¸»è¦åšåŠ¨ç”»æ•ˆæœè°ƒä¼˜ï¼‰

https://juejin.cn/post/7181356579709517861

schedule è°ƒåº¦ scheduler å°é¡¶å †æ•°æ®ç»“æ„
render åè°ƒ reconciler  fiber æ·±åº¦ä¼˜å…ˆéå†ï¼ˆdfsï¼‰
commit æ¸²æŸ“  render ReactDOM ReactArt

laneæ¨¡å‹ ä¼˜å…ˆçº§æ¨¡å‹ äº†è§£äºŒè¿›åˆ¶æ©ç 

ClassComponent     é¢å‘å¯¹è±¡
FunctionComponent  å‡½æ•°å¼ï¼ˆç¼–è¯‘æ—¶ä¼˜åŒ–ï¼ŒuseMemo useCallbackï¼‰

hooks ä»£æ•°æ•ˆåº”

event loop
message channel å®ä»»åŠ¡ å¾®ä»»åŠ¡


# ç†å¿µ
å¿«é€Ÿå“åº”
- CPUçš„ç“¶é¢ˆï¼šå½“é‡åˆ°å¤§è®¡ç®—é‡çš„æ“ä½œæˆ–è€…è®¾å¤‡æ€§èƒ½ä¸è¶³ä½¿é¡µé¢æ‰å¸§ï¼Œå¯¼è‡´å¡é¡¿ã€‚
    - æ—¶é—´åˆ‡ç‰‡ï¼šé¢„ç•™5msç»™react
- IOçš„ç“¶é¢ˆï¼šå‘é€ç½‘ç»œè¯·æ±‚åï¼Œç”±äºéœ€è¦ç­‰å¾…æ•°æ®è¿”å›æ‰èƒ½è¿›ä¸€æ­¥æ“ä½œå¯¼è‡´ä¸èƒ½å¿«é€Ÿå“åº”ã€‚
    - suspense + useDeferredValue  åŒæ­¥çš„æ›´æ–°ç¼–ç¨‹å¯ä¸­æ–­çš„å¼‚æ­¥æ›´æ–°
ä¸»æµæµè§ˆå™¨åˆ·æ–°é¢‘ç‡ä¸º 60Hzï¼Œå³æ¯ï¼ˆ1000ms / 60Hzï¼‰16.6ms æµè§ˆå™¨åˆ·æ–°ä¸€æ¬¡ã€‚
JSå¯ä»¥æ“ä½œDOMï¼ŒGUIæ¸²æŸ“çº¿ç¨‹ä¸JSçº¿ç¨‹æ˜¯äº’æ–¥çš„ã€‚æ‰€ä»¥JSè„šæœ¬æ‰§è¡Œå’Œæµè§ˆå™¨å¸ƒå±€ã€ç»˜åˆ¶ä¸èƒ½åŒæ—¶æ‰§è¡Œã€‚

## React15
React15 æ¶æ„å¯ä»¥åˆ†ä¸ºä¸¤å±‚ï¼š

Reconcilerï¼ˆåè°ƒå™¨ï¼‰â€”â€” è´Ÿè´£æ‰¾å‡ºå˜åŒ–çš„ç»„ä»¶
Rendererï¼ˆæ¸²æŸ“å™¨ï¼‰â€”â€” è´Ÿè´£å°†å˜åŒ–çš„ç»„ä»¶æ¸²æŸ“åˆ°é¡µé¢ä¸Š



åŒ…å«fiberã€åŒç¼“å­˜ã€JSXç¼–è¯‘ã€diffç®—æ³•ç­‰å†…å®¹ã€‚
CPUå¡é¡¿ï¼Œæ—¶é—´åˆ‡ç‰‡ï¼Œé¢„ç•™yieldInterval = 5msç»™jsï¼Œ
I/Oå¡é¡¿ï¼Œå°†åŒæ­¥çš„é•¿ä»»åŠ¡è½¬å˜ä¸ºå¯ä¸­æ–­çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¢åŠ loadingï¼ŒSuspense

React15åªæœ‰åŒæ­¥ä»»åŠ¡
- Reconciler åè°ƒå™¨
    1ã€è°ƒç”¨å‡½æ•°ç»„ä»¶æˆ–æ˜¯ç±»ç»„ä»¶çš„ render æ–¹æ³•ï¼Œå°†JSXè½¬åŒ–ä¸ºè™šæ‹ŸDOM
    2ã€å°†è™šæ‹ŸDOMå’Œä¸Šæ¬¡æ›´æ–°æ—¶çš„è™šæ‹ŸDOMå¯¹æ¯”ã€é€šè¿‡å¯¹æ¯”æ‰¾å‡ºéœ€è¦æ”¹å˜çš„è™šæ‹ŸDOM
    3ã€é€šçŸ¥Rendererå°†å˜åŒ–çš„è™šæ‹ŸDOMæ¸²æŸ“åˆ°é¡µé¢ä¸Š
- Renderer æ¸²æŸ“å™¨
    è´Ÿè´£å°†è™šæ‹ŸDOMæ¸²æŸ“åˆ°é¡µé¢ä¸Šã€‚

é—®é¢˜ï¼š
mountç»„ä»¶æ—¶ï¼Œä¼šè°ƒç”¨mountComponentæ–¹æ³•ï¼Œå®ƒä¼šæ ¹æ®æ ‡ç­¾è°ƒç”¨mountWrapperï¼Œè€ŒmountWrapperåˆä¼šè°ƒç”¨mountComponentæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œäº†é€’å½’çš„è¿‡ç¨‹ã€‚
åŒç†ï¼Œupdate ç»„ä»¶æ—¶ä¼šè§¦å‘updateComponentæ–¹æ³•ï¼Œä¹Ÿä¼šè¿›è¡Œé€’å½’ã€‚
å¦‚æœé€’å½’å±‚çº§å¾ˆæ·±ï¼Œé‚£ä¹ˆæ‰§è¡Œæ—¶é—´è¶…è¿‡16msæ—¶ï¼Œç”¨æˆ·äº¤äº’å°±ä¼šå¡é¡¿ã€‚
å¹¶ä¸”React15é‡‡ç”¨çš„é€’å½’æ–¹å¼ä¸æ”¯æŒä¸­æ–­ã€‚

React16
å¢åŠ Schedulerè°ƒåº¦å™¨ï¼Œè´Ÿè´£è®©é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å…ˆè¿›å…¥Reconcileræ‰§è¡Œã€‚
å¯¹äºä¼˜å…ˆçº§è°ƒåº¦ï¼Œå¾ˆå¤šäººæœ€å…ˆä¼šæƒ³åˆ°requestIdleCallbackè¿™ä¸ªAPIï¼Œç„¶è€Œå› ä¸ºå®ƒä¸å…¼å®¹safariï¼Œå¹¶ä¸”è§¦å‘é¢‘ç‡ä¸ç¨³å®šï¼Œå› æ­¤Reactå®ç°äº†è‡ªå·±çš„requestIdleCallbackpolyfillã€‚
React16è¿˜å®ç°äº†workLoopConcurrentï¼Œç”¨å¯ä¸­æ–­çš„å¼‚æ­¥ä»»åŠ¡æ¥ä»£æ›¿é€’å½’éå†çš„æ–¹å¼ï¼Œé€šè¿‡shouldYieldæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­ã€‚



ä¸èƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸Šç›´æ¥ä½¿ç”¨refï¼Œå› ä¸ºå…¶æ²¡æœ‰å®ä¾‹



# é—®é¢˜
çˆ¶ç»„ä»¶å†…éƒ¨çŠ¶æ€æ›´æ–°ï¼Œå­ç»„ä»¶ä¸åº”è¯¥æ›´æ–°
è·¨ç»„ä»¶ä¼ å€¼å¯¼è‡´ä¸­é—´ç»„ä»¶ä¸å¿…è¦çš„æ›´æ–°






# è°ƒå’Œé˜¶æ®µ
1ã€è®¡ç®—å‡ºç›®æ ‡ State å¯¹åº”çš„è™šæ‹Ÿ DOM ç»“æ„ã€‚
2ã€å¯»æ‰¾ã€Œå°†è™šæ‹Ÿ DOM ç»“æ„ä¿®æ”¹ä¸ºç›®æ ‡è™šæ‹Ÿ DOM ç»“æ„ã€çš„æœ€ä¼˜æ›´æ–°æ–¹æ¡ˆã€‚

æŒ‰ç…§æ·±åº¦ä¼˜å…ˆéå†è™šæ‹Ÿ DOM æ ‘çš„æ–¹å¼ï¼Œåœ¨ä¸€ä¸ªè™šæ‹Ÿ DOM ä¸Šå®Œæˆä¸¤ä»¶äº‹çš„è®¡ç®—åï¼Œå†è®¡ç®—ä¸‹ä¸€ä¸ªè™šæ‹Ÿ DOMã€‚ç¬¬ä¸€ä»¶äº‹ä¸»è¦æ˜¯è°ƒç”¨ç±»ç»„ä»¶çš„ render æ–¹æ³•æˆ–å‡½æ•°ç»„ä»¶è‡ªèº«ã€‚ç¬¬äºŒä»¶äº‹ä¸º React å†…éƒ¨å®ç°çš„ Diff ç®—æ³•ï¼ŒDiff ç®—æ³•ä¼šè®°å½•è™šæ‹Ÿ DOM çš„æ›´æ–°æ–¹å¼ï¼ˆå¦‚ï¼šUpdateã€Mountã€Unmountï¼‰ï¼Œä¸ºæäº¤é˜¶æ®µåšå‡†å¤‡ã€‚

# æäº¤é˜¶æ®µ
1ã€å°†è°ƒå’Œé˜¶æ®µè®°å½•çš„æ›´æ–°æ–¹æ¡ˆåº”ç”¨åˆ° DOM ä¸­ã€‚
2ã€è°ƒç”¨æš´éœ²ç»™å¼€å‘è€…çš„é’©å­æ–¹æ³•ï¼Œå¦‚ï¼šcomponentDidUpdateã€useLayoutEffect ç­‰ã€‚ 

æäº¤é˜¶æ®µä¸­è¿™ä¸¤ä»¶äº‹çš„æ‰§è¡Œæ—¶æœºä¸è°ƒå’Œé˜¶æ®µä¸åŒï¼Œåœ¨æäº¤é˜¶æ®µ React ä¼šå…ˆæ‰§è¡Œ 1ï¼Œç­‰ 1 å®Œæˆåå†æ‰§è¡Œ 2ã€‚å› æ­¤åœ¨å­ç»„ä»¶çš„ componentDidMount æ–¹æ³•ä¸­

è°ƒå’Œé˜¶æ®µçš„ã€ŒDiff è¿‡ç¨‹ã€å’Œæäº¤é˜¶æ®µçš„ã€Œåº”ç”¨æ›´æ–°æ–¹æ¡ˆåˆ° DOMã€éƒ½å±äº React çš„å†…éƒ¨å®ç°ï¼Œå¼€å‘è€…èƒ½æä¾›çš„ä¼˜åŒ–èƒ½åŠ›æœ‰é™ï¼Œå®é™…å·¥ç¨‹ä¸­å¤§éƒ¨åˆ†ä¼˜åŒ–æ–¹å¼éƒ½é›†ä¸­åœ¨è°ƒå’Œé˜¶æ®µçš„ã€Œè®¡ç®—ç›®æ ‡è™šæ‹Ÿ DOM ç»“æ„ã€è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹æ˜¯ä¼˜åŒ–çš„é‡ç‚¹ï¼ŒReact å†…éƒ¨çš„ Fiber æ¶æ„å’Œå¹¶å‘æ¨¡å¼ä¹Ÿæ˜¯åœ¨å‡å°‘è¯¥è¿‡ç¨‹çš„è€—æ—¶é˜»å¡ã€‚å¯¹äºæäº¤é˜¶æ®µçš„ã€Œæ‰§è¡Œé’©å­å‡½æ•°ã€è¿‡ç¨‹ï¼Œå¼€å‘è€…åº”ä¿è¯é’©å­å‡½æ•°ä¸­çš„ä»£ç å°½é‡è½»é‡ï¼Œé¿å…è€—æ—¶é˜»å¡

React.memo æ˜¯å¯¹å‡½æ•°ç»„ä»¶çš„ Props è¿›è¡Œæµ…æ¯”è¾ƒã€‚

useMemo æ˜¯ä¸€ç§ç¼“å­˜æœºåˆ¶æé€Ÿï¼Œå½“å®ƒçš„ä¾èµ–æœªå‘ç”Ÿæ”¹å˜æ—¶ï¼Œå°±ä¸ä¼šè§¦å‘é‡æ–°è®¡ç®—ã€‚useMemo ç¼“å­˜åŠ é€Ÿåªèƒ½ç¼“å­˜æœ€è¿‘ä¸€æ¬¡å‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œå¦‚æœæƒ³ç¼“å­˜æ›´å¤šæ¬¡å‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œå¯ä½¿ç”¨ memoizee

é‚£ä¹ˆä½¿ç”¨ key å±æ€§å°±ä¸åªèŠ‚çœäº† DOM æ›´æ–°ï¼Œè¿˜é¿å…äº†ç»„ä»¶çš„ Render è¿‡ç¨‹ã€‚

åœ¨ React ç®¡ç†çš„äº‹ä»¶å›è°ƒå’Œç”Ÿå‘½å‘¨æœŸä¸­ï¼ŒsetState æ˜¯å¼‚æ­¥çš„ï¼Œè€Œå…¶ä»–æ—¶å€™ setState éƒ½æ˜¯åŒæ­¥çš„ã€‚è¿™ä¸ªé—®é¢˜æ ¹æœ¬åŸå› å°±æ˜¯ React åœ¨è‡ªå·±ç®¡ç†çš„äº‹ä»¶å›è°ƒå’Œç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯¹äº setState æ˜¯æ‰¹é‡æ›´æ–°çš„ï¼Œè€Œåœ¨å…¶ä»–æ—¶å€™æ˜¯ç«‹å³æ›´æ–°çš„ã€‚

# setState
æ‰¹é‡æ›´æ–° setState æ—¶ï¼Œå¤šæ¬¡æ‰§è¡Œ setState åªä¼šè§¦å‘ä¸€æ¬¡ Render è¿‡ç¨‹ã€‚ç›¸ååœ¨ç«‹å³æ›´æ–° setState æ—¶ï¼Œæ¯æ¬¡ setState éƒ½ä¼šè§¦å‘ä¸€æ¬¡ Render è¿‡ç¨‹ï¼Œå°±å­˜åœ¨æ€§èƒ½å½±å“ã€‚
è§£å†³åŠæ³•ï¼š
1ã€å°†å¤šä¸ª State åˆå¹¶ä¸ºå•ä¸ª Stateã€‚ä¾‹å¦‚ useState({ list: null, info: null }) æ›¿ä»£ list å’Œ info ä¸¤ä¸ª Stateã€‚
2ã€ä½¿ç”¨ React å®˜æ–¹æä¾›çš„ unstable_batchedUpdates æ–¹æ³•ï¼Œå°†å¤šæ¬¡ setState å°è£…åˆ° unstable_batchedUpdates å›è°ƒä¸­ã€‚
```
const [list, setList] = useState(null)
const [info, setInfo] = useState(null)
useEffect(() => {
(async () => {
    const data = await getData()
    unstable_batchedUpdates(() => {
    setList(data.list)
    setInfo(data.info)
    })
})()
}, [])
```
ä¸ºä»€ä¹ˆé¢è¯•å®˜ä¸ä¼šé—®â€œå‡½æ•°ç»„ä»¶ä¸­çš„ setState æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿâ€ï¼Ÿå› ä¸ºå‡½æ•°ç»„ä»¶ä¸­ç”Ÿæˆçš„å‡½æ•°æ˜¯é€šè¿‡é—­åŒ…å¼•ç”¨äº†stateï¼Œè€Œä¸æ˜¯é€šè¿‡ this.state çš„æ–¹å¼å¼•ç”¨ stateï¼Œæ‰€ä»¥å‡½æ•°ç»„ä»¶çš„å¤„ç†å‡½æ•°ä¸­ state ä¸€å®šæ˜¯æ—§å€¼ï¼Œä¸å¯èƒ½æ˜¯æ–°å€¼ã€‚å¯ä»¥è¯´å‡½æ•°ç»„ä»¶å·²ç»å°†è¿™ä¸ªé—®é¢˜å±è”½æ‰äº†ï¼Œæ‰€ä»¥é¢è¯•å®˜ä¹Ÿå°±ä¸ä¼šé—®äº†ã€‚

# é—®é¢˜
1ã€å¦‚æœåªæœ‰çˆ¶ç»„ä»¶å‘ç”ŸçŠ¶æ€æ›´æ–°ï¼Œå³ä½¿çˆ¶ç»„ä»¶ä¼ ç»™å­ç»„ä»¶çš„æ‰€æœ‰ Props éƒ½æ²¡æœ‰ä¿®æ”¹ï¼Œä¹Ÿä¼šå¼•èµ·å­ç»„ä»¶çš„ Render è¿‡ç¨‹ã€‚
è§£å†³ï¼šReact.memoæˆ–è€…pureComponent
2ã€å½“å¤§å¯¹è±¡ä¸­æŸä¸ªã€Œå­ç»„ä»¶æœªä½¿ç”¨çš„å±æ€§ã€å‘ç”Ÿäº†æ›´æ–°ï¼Œå­ç»„ä»¶ä¹Ÿä¼šè§¦å‘ Render è¿‡ç¨‹ã€‚
è§£å†³ï¼šå®ç°å­ç»„ä»¶çš„ shouldComponentUpdate æ–¹æ³•ï¼Œä»…åœ¨ã€Œå­ç»„ä»¶ä½¿ç”¨çš„å±æ€§ã€å‘ç”Ÿæ”¹å˜æ—¶æ‰æ›´æ–°
3ã€å‘å¸ƒè€…è®¢é˜…è€…è·³è¿‡ä¸­é—´ç»„ä»¶ Render è¿‡ç¨‹
React.createContext/useContext
4ã€useMemo è¿”å›è™šæ‹Ÿ DOM å¯è·³è¿‡è¯¥ç»„ä»¶ Render è¿‡ç¨‹
åˆ©ç”¨ useMemo å¯ä»¥ç¼“å­˜è®¡ç®—ç»“æœçš„ç‰¹ç‚¹ï¼Œå¦‚æœ useMemo è¿”å›çš„æ˜¯ç»„ä»¶çš„è™šæ‹Ÿ DOMï¼Œåˆ™å°†åœ¨ useMemo ä¾èµ–ä¸å˜æ—¶ï¼Œè·³è¿‡ç»„ä»¶çš„ Render é˜¶æ®µã€‚
è¯¥æ–¹å¼ä¸ React.memo ç±»ä¼¼ï¼Œä½†ä¸ React.memo ç›¸æ¯”æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š
æ›´æ–¹ä¾¿ã€‚React.memo éœ€è¦å¯¹ç»„ä»¶è¿›è¡Œä¸€æ¬¡åŒ…è£…ï¼Œç”Ÿæˆæ–°çš„ç»„ä»¶ã€‚è€Œ useMemo åªéœ€åœ¨å­˜åœ¨æ€§èƒ½ç“¶é¢ˆçš„åœ°æ–¹ä½¿ç”¨ï¼Œä¸ç”¨ä¿®æ”¹ç»„ä»¶ã€‚
æ›´çµæ´»ã€‚useMemo ä¸ç”¨è€ƒè™‘ç»„ä»¶çš„æ‰€æœ‰ Propsï¼Œè€Œåªéœ€è€ƒè™‘å½“å‰åœºæ™¯ä¸­ç”¨åˆ°çš„å€¼ï¼Œä¹Ÿå¯ä½¿ç”¨ useDeepCompareMemo[24] å¯¹ç”¨åˆ°çš„å€¼è¿›è¡Œæ·±æ¯”è¾ƒã€‚

çˆ¶ç»„ä»¶çŠ¶æ€æ›´æ–°åï¼Œä¸ä½¿ç”¨ useMemo çš„å­ç»„ä»¶ä¼šæ‰§è¡Œ Render è¿‡ç¨‹ï¼Œè€Œä½¿ç”¨ useMemo çš„å­ç»„ä»¶ä¸ä¼šæ‰§è¡Œã€‚
```
const comp = useMemo(() => {
    return <Comp name="ä½¿ç”¨ useMemo ä½œä¸º children" />
  }, [])
```

# æ‡’åŠ è½½
```
import { lazy, Suspense, Component } from 'react'
import './styles.css'

// å¯¹åŠ è½½å¤±è´¥è¿›è¡Œå®¹é”™å¤„ç†
class ErrorBoundary extends Component {
  constructor(props) {
    super(props)
    this.state = { hasError: false }
  }

  static getDerivedStateFromError(error) {
    return { hasError: true }
  }

  render() {
    if (this.state.hasError) {
      return <h1>è¿™é‡Œå¤„ç†å‡ºé”™åœºæ™¯</h1>
    }

    return this.props.children
  }
}

const Comp = lazy(() => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (Math.random() > 0.5) {
        reject(new Error('æ¨¡æ‹Ÿç½‘ç»œå‡ºé”™'))
      } else {
        resolve(import('./Component'))
      }
    }, 2000)
  })
})

export default function App() {
  return (
    <div className="App">
      <div style={{ marginBottom: 20 }}>
        å®ç°æ‡’åŠ è½½ä¼˜åŒ–æ—¶ï¼Œä¸ä»…è¦è€ƒè™‘åŠ è½½æ€ï¼Œè¿˜éœ€è¦å¯¹åŠ è½½å¤±è´¥è¿›è¡Œå®¹é”™å¤„ç†ã€‚
      </div>
      <ErrorBoundary>
        <Suspense fallback="Loading...">
          <Comp />
        </Suspense>
      </ErrorBoundary>
    </div>
  )
}
```